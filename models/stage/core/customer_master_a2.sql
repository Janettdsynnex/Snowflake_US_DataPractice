{{
     config(
         alias = 'customer_master_a2',
         materialized = 'table'
     )
 }}



with cust_xref as (
       
        select xref.*, to_char(cust.mcust_no) mcust_no
        from (
            select to_char(cust_no) cust_no, 
                   xref,  
                   xref_no,
                   ROW_NUMBER() OVER (PARTITION BY xref ORDER BY entry_datetime desc) as rn
                from {{ source('us_cdp_cis_us','DIM_PUB_CUSTOMER_XREF_US') }} a
                --from ANALYTICS.EDW_CIS_US.DIM_PUB_CUSTOMER_XREF_US a
                where xref_type = 'LTD_CUST'                
                      ) xref
        left join {{ source('us_cdp_cis_us','DIM_PUB_CUSTOMER_INFO_VIEW_US') }} cust
        --left join ANALYTICS.EDW_CIS_US.DIM_PUB_CUSTOMER_INFO_VIEW_US cust
          on xref.cust_no = cust.cust_no
        where rn = 1
                   )

SELECT 
MD5(CONCAT(T1.SOURSYSTEM,T1.TNSALEORG,'00','01',T1.TNCBPCUST)) AS CUSTOMER_MASTER_KEY,  
T1.SOURSYSTEM AS SOURSYSTEM,
'US01' AS SALES_ORG,
'US01' AS COMPANY_CODE,  
'00' AS DIVISION,
'01' AS DISTR_CHANNEL,
T1.TNCBPCUST AS RESELLER_ID,
T1.TUCCUSTOR_46 AS RESELLER_ID_46,
nvl(cust_xref.mcust_no, T1.TNCBPCUST) as RESELLER_ID_COMBINED,
T1.TNCBPCUST AS RESELLER_ID_68 ,
NULL AS ACCOUNT_CLOSURE_FLAG,
IFF(T1.TNCDELINDC = 'X' OR T7.DEL_INDIC = 'X' , TRUE, FALSE) AS DELETION_FLAG_MAIN, 
NULL AS LAST_PACE_FLAG,
NULL AS PACE_FLAG_UPDATE,
NULL AS LAST_PACE_CLUSTER,
NULL AS LAST_CE_SEGMENT_TEXT,
NULL AS LAST_CE_SEGMENT_ID,
NULL AS CE_PERIOD_START,
NULL AS CE_PERIOD_END,
NULL AS LAST_LCS_STAGE,
NULL AS LAST_LCS_STAGE_TEXT,
NULL AS LAST_LCS_STAGE_UPDATE,
NULL AS LAST_LCS_STAGE_TEXT_CISCO,
NULL AS LAST_LCS_STAGE_UPDATE_CISCO,
NULL AS TS_CUST_ACCOUNT,
nvl(cust_xref.mcust_no, nvl(cust46."/BIC/TUCHIEC03", cust68."/BIC/TNGLBCUST")) as GROUPKEY,
NULL AS DNB_DUNS_NBR,
NULL AS DNB_CONFIDENCE_CODE,
NULL AS DNB_NAME_SCORE,
NULL AS DNB_CITY_SCORE,
NULL AS DNB_STATE_SCORE,
NULL AS DNB_STRNAME_SCORE,
NULL AS DNB_STRNUMB_SCORE,
NULL AS DNB_PHONE_SCORE,
NULL AS DNB_POBOX_SCORE,
T1.TNCCUSTYP as CUSTOMER_ACCNT_GROUP,
NULL AS ADDRESS,
T1.TNCCITY AS CITY,
T1.TNCCOUNTRY AS COUNTRY_KEY, 
NULL AS CUST_CLASSIFICATION,
NULL AS COUNTY_CODE,  
NULL AS CUSTOMER_IS_CONSUMER,
T1.TNCDELINDC AS DELETION_FLAG,
NULL AS DUNS_NBR,
NULL AS FAX_NBR,
T1.TUCINDUSY AS INDUSTRY_KEY,
T6."/BIC/TUCINDUSY" AS INDUSTRY_KEY_TEXT,
NULL AS INDUSTRY_CODE_1,
NULL AS INDUSTRY_CODE_2,
NULL AS INDUSTRY_CODE_3,
NULL AS INDUSTRY_CODE_4,
NULL AS INDUSTRY_CODE_5,
NULL AS LANGUAGE_KEY,
T1.TNCNAME AS RESELLER_NAME,
NULL AS NAME_2,
NULL AS NAME_3,
NULL AS NIELSEN_ID,
NULL AS TRADING_PARTNER,
T1.TNCTELNUM AS FIRST_TELEPHONE_NBR,
NULL AS PLANT,
NULL AS PO_BOX,
T1.TNCPOSTLCD AS POSTAL_CODE,
NULL AS CAM_PO_BOX,
NULL AS CAM_POSTAL_CODE_GEO,
T1.TNCREGION AS REGION,
T1.TNCSTREET AS HOUSE_NBR_AND_STR ,
NULL AS SORT_FIELD,
NULL AS TAX_NBR_1 ,
NULL AS TAX_NBR_2,
NULL AS MATERIAL_USAGE_IND,
NULL AS VENDOR,
NULL AS ORDER_BLOCK,
NULL AS INTL_LOCATION_NBR_1,
NULL AS INTL_LOCATION_NBR_2,
NULL AS CHECK_DIGIT_INTL_LOC,
NULL AS CUST_EMAIL_ADDRESS,

CASE  
  WHEN TO_CHAR(t1.CREATEDON) IN(NULL, '', '00000000') THEN NULL
ELSE TO_DATE(TO_CHAR(T1.CREATEDON, 'YYYY-MM-DD'))
END AS CREATION_DATE,

NULL AS BILL_BLOCK,
NULL AS LEGAL_STATUS,
NULL AS ASGMT_TO_HRCHY,
NULL AS DELIVERY_WAVER,
NULL AS LEASING_COMPANY,
NULL AS ECOM_DISCOUNT_GROUP,
NULL AS INTEREST_GROUP,
NULL AS DELIVERY_BLOCK,
NULL AS TRANSPORTATION_ZONE,
NULL AS NAME_4,
NULL AS DISTRICT ,
NULL AS PO_BOX_CITY,
NULL AS VAT_REGISTRATION_NBR,
NULL AS TELEBOX_NBR,
NULL AS FAX_NBR_2,
NULL AS CUST_COMM_TELETEX,
NULL AS VAT_COUNTRY_KEY,
NULL AS GLBL_MFR,
NULL AS STREET_4,
NULL AS DATA_LINE,
NULL AS ANNUAL_SALES,
NULL AS CURRENCY_SALES_FIG ,
NULL AS FISCAL_YEAR_VARIANT,
NULL AS FLAG_NON_VAT_REG,
NULL AS EUROPEAN_CUST_GROUP,
NULL AS CUST_GLBL_ACCNT,
NULL AS CUST_LOCAL_GRP,
NULL AS BUSINESS_PARTNER,
NULL AS MIN_QTY_SURCHARGE_GR,
NULL AS HUNTING_STATUS,
NULL AS TAX_JURISDICTION_COD,
NULL AS TELEPHONE_EXTENSION,
NULL AS TAX_CODE_3,
NULL AS AUTHORIZATION_GRP,
NULL AS DOING_BUSINESS_AS_1,
NULL AS DOING_BUSINESS_AS_2,
NULL AS DATA_MEDIUM_EXCHANGE,
NULL AS CUST_CLASS_SUPPLIES,
NULL AS VENDOR_CLASS_NBR,
NULL AS VENDOR_CLASS,
T1.TNCBPCUST AS CUST_NBR_COMP_CODE,
NULL AS DUNNING_CLERK,
NULL AS ACCNT_NBR_DUN_RECIP,
NULL AS CREDIT_CONTROL_AREA_CC, 
NULL AS DELETION_FLAG_CC,
NULL AS EMPLOYEE,
NULL AS PAYMENT_TERMS_CC,
NULL AS PAYMENT_BLOCK_KEY,
NULL AS PAYMENT_METHOD_SUPPL,
NULL AS PREV_MASTER_REC_NBR,
NULL AS ACCNT_CLERK,
NULL AS BLOCK_BY_CRED_MNGMT,
NULL AS RISK_CTGRY_NEW_CUST,
NULL AS CUST_RATING,
NULL AS LEGAL_DUNN_PROCEED,
NULL AS CUST_CREDIT_GRP,
NULL AS HEAD_OFFICE_ACCNT_NBR,
NULL AS CREDIT_MEMO_TERMS,
NULL AS COLLECTIVE_INV_VAR,
NULL AS CREDIT_MGMT_REPS_GRP,
NULL AS TOLERANCE_GRP,
NULL AS INS_VALIDITY_DATE,
NULL AS INS_INSTITUTION_NBR,
NULL AS INS_NBR,
NULL AS INTEREST_CALC_NBR,
NULL AS EXCH_RATE_PAYM_TERMS,
NULL AS BANK_STATEMENT,
NULL AS PAYMENT_METHODS,
NULL AS CREDIT_MEMO_PAYM_TERM,
NULL AS INTERNET_ADDRESS,
NULL AS CUST_CREDIT_LIMIT,
NULL AS CREDIT_EXPOSURE_HORZ,
NULL AS NBR_OF_RECORDS_CC,
NULL AS ACCNT_BALANCE,
NULL AS AMOUNT_INSURED,
NULL AS TOT_BANK_GUARANTEES,
NULL AS LAST_GEN_INFO,
NULL AS CURRENCY_KEY_AMNT_INS,
NULL AS CURRENCY_KEY_CC,
NULL AS RECONCILIATION_ACCNT,
NULL AS CHART_OF_ACCNTS,
NULL AS CUST_ACCNT_NBR_CL_REF,
NULL AS CASH_MGMT_GRP,
NULL AS CREDIT_MANAGER,
NULL AS GRP_RELATIONSHIP,
NULL AS AUTHORIZATION_GRP_CC,
NULL AS SORTING_KEY,
NULL AS OLD_CUST_NBR,
NULL AS DUNNING_PROCEDURE,
NULL AS KEY_OF_THE_LOCKBOX,
NULL AS CREDIT_PARENT_ACCNT,
NULL AS NEXT_INTERNAL_REVIEW,
NULL AS DATE_OF_LAST_DUNNING,
NULL AS DUNNING_LEVEL,
NULL AS DUNNING_BLOCK,
T1.TNCBPCUST AS CUST_SALES,
NULL AS LAST_BILL_DATE,
NULL AS VENDOR_CLASS_SS,
NULL AS VENDOR_CLASS_NBR_SS,
T1.TNCCUSTYP AS CUST_ACCNT_ASGMT_GRP,
NULL AS CUST_CLASS_ABC,
NULL AS CUST_GRP,
NULL AS PROFILE_COLUMN_CUST,
NULL AS CUST_GRP_2,
NULL AS CUST_GRP_TXT,
NULL AS FREIGHT_COLUMN,
NULL AS SPECIAL_HANDLING_IND,
NULL AS ORDER_FULFILLMENT,
NULL AS CREDIT_CONTROL_AREA_SS, 
T7.DEL_INDIC AS DELETION_FLAG_SS,
NULL AS INCOTERMS_PART_1,
NULL AS INCOTERMS_PART_2,
NULL AS PLANT_SS,
NULL AS PAYMENT_TERMS_SS,
NULL AS SALES_DISTRICT,
NULL AS SALES_GRP,
NULL AS SALES_OFFICE,
NULL AS ACTIVITY_FLAG,
NULL AS ORDER_BLOCK_SS,
NULL AS CUST_CLASS_ENTERPRISE,
NULL AS CUST_RECEIVE_REBATES,
NULL AS EDI_CUST_GRP,
NULL AS EDI_STATUS,
NULL AS BILL_BLOCK_SS,
NULL AS FLOATING_LOGO,
NULL AS FOUNDATION_DATE ,
NULL AS GOLDMINE_FLAG,
NULL AS GVF_EXCEPTION_CODE,
T1.TUCHIEA01 AS SUPER_SALES_AREA,
T1.TUCHIEA02 AS SALES_AREA,
T1.TUCHIEA03 AS SALES_EXECUTIVE,
NULL AS SALES_DIRECTOR,
NULL AS AREA_SALES_MANAGER,
T1.TUCHIEB03 AS SALES_REP,
NULL AS INTL_HQ,
NULL AS REGIONAL_HQ,
NULL AS COUNTRY_HQ ,
NULL AS REGIONAL_SUBSIDIARY,
NULL AS LOC_HRCHY_D_LVL_01,
NULL AS LOC_HRCHY_D_LVL_02,
NULL AS LOC_HRCHY_D_LVL_03,
NULL AS LOC_HRCHY_D_LVL_04,
NULL AS LOC_HRCHY_E_LVL_01,
NULL AS LOC_HRCHY_E_LVL_02,
NULL AS LOC_HRCHY_E_LVL_03,
NULL AS LOC_HRCHY_E_LVL_04,
NULL AS LOC_HRCHY_F_LEV_01,
NULL AS LOC_HRCHY_F_LVL_02,
NULL AS LOC_HRCHY_F_LVL_03,
NULL AS SUPER_SALES_AREA_G,
NULL AS SALES_AREA_MD_G,
NULL AS INTERNAL_ACCNT_MANAGER,
NULL AS PRICING_PROCEDURE,
NULL AS PRICE_GRP,
NULL AS ORDER_COMBINATION,
NULL AS PARTIAL_DELIVERY_AT_,
NULL AS LAST_EDI_OR_XML,
NULL AS DELIVERY_BLOCK_SS,
NULL AS LAST_INTOUCH_ORDER,
NULL AS LAST_ORDER,
NULL AS DELIVERY_PRIORITY,
NULL AS INVOICE_DATES,
NULL AS PRICE_LIST_TYPE,
NULL AS HP_NAMED_ACCNTS,
NULL AS AZLAN_VALUE_CUST,
NULL AS MS_MANAGED_PARTNER,
NULL AS LAST_COL_CHANGE_DAT,
NULL AS CUST_STATS_GRP,
NULL AS SHIPPING_CONDS,
NULL AS WEEE_EXCEPTION_CODE,
NULL AS TOP_100_ACCNTS_FLAG,
NULL AS WORST_ACCNTS_FLAG,
NULL AS HUNTING_FLAG,
NULL AS WAKE_UP_FLAG,
NULL AS INCLUDED_SMB_PLAN,
NULL AS EXCLUDED_SMB_PLAN,
NULL AS DROP_SHIPMENT_FLAG,
NULL AS PICK_UP_FLAG,
NULL AS EXCHANGE_RATE_TYPE,
NULL AS NBR_OF_RECORDS_SS,
NULL AS CURRENCY_KEY_SS,
NULL AS POD_RELEVANT,
NULL AS ABC_CUST,
NULL AS HP_CLASS,
NULL AS FREIGHT_DROPSHIPMENT,
NULL AS MANAGED_ACCNTS,
NULL AS LOC_HRCHY_H_LVL_01,
NULL AS LOC_HRCHY_H_LVL_02,
NULL AS LOC_HRCHY_H_LVL_03,
NULL AS TELCO_CUST_FLAG,
NULL AS DIGITAL_SIGNATURE,
NULL AS PAM_LC,
NULL AS CENTRAL_PAM_EUR,
NULL AS PAM_LAST_UPDATE,
NULL AS LOC_CURRENCY,
NULL AS CUST_DESIGNATION_GRP,
NULL AS ORDER_PRIORITIZATION,
NULL AS PROCEDURE_PROD_PROPOSAL,
NULL AS INVENTORY_SOURCE,
NULL AS US_BASED_EXPORTERS,
NULL AS FREIGHT_FORWARDER,
NULL AS BUY_BACK_TRADE_IN,
NULL AS AFFORDABILITY_PORTAL, 
NULL AS CUST_UNWILLING,
T1.TUCSALESG AS LEGACY_SALES_ORG,
SYSDATE() as UPDATE_DATE_UTC
FROM {{ source('us_cdp','CUSTOMERMASTER_BASE_68_MAPPED') }}  AS T1 
--FROM  US_DATAPRACTICE.CDP.CUSTOMERMASTER_BASE_68_MAPPED   AS T1
LEFT JOIN cust_xref
  ON ltrim(T1.TNCBPCUST,0) = cust_xref.xref 
LEFT JOIN {{ source('us_cdp_bw_68','TNCBPCUST') }} cust68
--LEFT JOIN ANALYTICS.EDW_SAP_BW_US_68.TNCBPCUST cust68
  ON T1.TNCBPCUST = cust68."/BIC/TNCBPCUST"
  AND cust68.SOURSYSTEM = 'A2'
LEFT JOIN  {{ source('us_cdp_bw_46','TUCINDUSY_TXT') }} AS T6
--LEFT JOIN ANALYTICS.EDW_SAP_BW_US_46.TUCINDUSY_TXT  AS T6
  ON T1.TUCINDUSY = T6."/BIC/TUCINDUSY"
LEFT JOIN  {{ source('us_cdp_bw_46','TUCCUSTSS') }} cust46
--LEFT JOIN ANALYTICS.EDW_SAP_BW_US_46.TUCCUSTSS cust46
  ON cust68."/BIC/TNECUSNU" = cust46."/BIC/TUCCUSTSS" 
  AND cust46.SOURSYSTEM = 'A3'
  AND cust46."/BIC/TUCDISTRN" = '00'
  AND cust46."/BIC/TUCDIVISN" = '10'
  AND cust46."/BIC/TUCSALESG" = '0100'
--LEFT JOIN ANALYTICS.EDW_SAP_BW_US_68.TNCUST_SL T7
LEFT JOIN {{ source('us_cdp_bw_68','TNCUST_SL') }} T7
  ON T1.TNCBPCUST = T7.TNCUST_SL  
  AND T1.TUCSALESG = T7.TNSALEORG 
  AND T7.SOURSYSTEM = 'A2'
  AND T7.TNDISTNCH = '01'
  AND T7.TNDIV_SLS = '00'
WHERE T1.TNSALEORG in('1001', 'A001', 'US33')